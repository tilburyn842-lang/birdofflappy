<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird of Flappy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', monospace;
        }
        
        @font-face {
            font-family: 'PixelFont';
            src: local('Courier New'), local('monospace');
        }
        
        * {
            font-family: 'PixelFont', 'Courier New', monospace !important;
        }
        
        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        #score {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            color: white;
            z-index: 10;
            font-weight: bold;
            text-align: center;
        }
        
        #coins {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
        }
        
        .coins-display {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            border: 3px solid #FFD700;
            border-radius: 10px;
            padding: 8px 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        
        .coin-icon-game {
            width: 32px;
            height: 32px;
            background: radial-gradient(circle at 30% 30%, #FFD700, #FFA500);
            border-radius: 50%;
            border: 2px solid #FF8C00;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: #FF8C00;
        }
        
        .coin-count {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin-left: 6px;
        }
        
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        #startScreen.active {
            opacity: 1;
            pointer-events: all;
        }
        
        #startScreen h1 {
            font-size: 60px;
            margin-bottom: 15px;
            color: #FFD700;
            letter-spacing: 5px;
            animation: bounce 2s infinite;
            text-align: center;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        #startScreen p {
            font-size: 20px;
            color: white;
            margin-bottom: 5px;
        }
        
        .stats-display {
            display: flex;
            gap: 30px;
            margin: 15px 0;
            font-size: 24px;
            color: white;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .button-row {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .play-button {
            background: linear-gradient(135deg, #FF6B6B, #FF3838);
            color: white;
            border: 4px solid #FFD700;
            padding: 15px 60px;
            font-size: 32px;
            margin: 15px;
            cursor: pointer;
            border-radius: 15px;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            transition: all 0.3s;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .play-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0,0,0,0.7);
        }
        
        .play-button:active {
            transform: translateY(-2px) scale(1.02);
        }
        
        .fade-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 250;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease;
        }
        
        .fade-overlay.active {
            opacity: 1;
        }
        
        #shop, #leaderboard {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: rgba(0,0,0,0.97);
            padding: 20px;
            overflow-y: auto;
            z-index: 200;
            transition: right 0.3s ease;
            border-left: 3px solid #5cb85c;
        }
        
        #shop.open, #leaderboard.open {
            right: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 150;
            display: none;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
        .menu-button {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border: 3px solid #FFD700;
            padding: 15px;
            font-size: 18px;
            margin: 0;
            cursor: pointer;
            border-radius: 15px;
            font-weight: bold;
            width: 160px;
            height: 160px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }
        
        .menu-button:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 12px 25px rgba(0,0,0,0.6);
            background: linear-gradient(135deg, #5EDDD4, #54B09D);
        }
        
        .menu-button:active {
            transform: translateY(-2px) scale(1.01);
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 15px 0;
        }
        
        .shop-section {
            margin: 20px 0;
        }
        
        .section-title {
            font-size: 24px;
            color: #FFD700;
            margin-bottom: 15px;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 5px;
        }
        
        .item-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 2px solid #5cb85c;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .item-card:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            transform: translateX(5px);
            border-color: #FFD700;
        }
        
        .item-card.equipped {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
        }
        
        .item-card.locked {
            opacity: 0.6;
        }
        
        .item-preview {
            width: 60px;
            height: 60px;
            border: 2px solid #000;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-size: 18px;
            margin: 0 0 5px 0;
            color: white;
            font-weight: bold;
        }
        
        .item-description {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .item-price {
            font-size: 16px;
            color: #FFD700;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .leaderboard-table {
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .leaderboard-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            margin: 4px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 14px;
            color: white;
        }
        
        .leaderboard-row.top {
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid #FFD700;
        }
        
        .leaderboard-row.you {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }
        
        .back-btn {
            position: static;
            background: linear-gradient(135deg, #d9534f, #c9302c);
            border-color: #FFD700;
            padding: 10px 20px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 15px;
            height: auto;
        }
        
        .hidden {
            display: none !important;
        }
        
        .leaderboard-header {
            font-size: 20px;
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .shop-currency {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255,215,0,0.1);
            border-radius: 10px;
            border: 2px solid #FFD700;
        }
        
        .shop-coin-icon {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #FFD700, #FFA500);
            border-radius: 50%;
            border: 2px solid #FF8C00;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: #FF8C00;
        }
        
        .shop-coin-count {
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
        }
        
        .effect-indicator {
            position: absolute;
            bottom: 60px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #FF00FF;
            color: #FF00FF;
            font-size: 16px;
            z-index: 20;
            display: none;
            font-weight: bold;
        }
        
        .effect-indicator.active {
            display: block;
        }
        
        #effectText {
            color: #FF00FF;
        }
        
        .loading {
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 16px;
        }
        
        .error {
            color: #ff6b6b;
            text-align: center;
            padding: 20px;
            font-size: 16px;
        }
        
        .coin-reward {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 30;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
            border: 3px solid #FF8C00;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        .coin-reward.show {
            opacity: 1;
            animation: rewardPulse 1s ease-out;
        }
        
        @keyframes rewardPulse {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 1; }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }
        
        .boss-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            color: #FF0000;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 0 20px #FF0000, 0 0 40px #FF0000;
            font-weight: bold;
            letter-spacing: 5px;
        }
        
        .boss-warning.show {
            opacity: 1;
            animation: bossWarning 2s ease-out;
        }
        
        @keyframes bossWarning {
            0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            40% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            60% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        .stage-indicator {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: #00FF00;
            z-index: 30;
            opacity: 0.8;
            font-weight: bold;
            text-shadow: 0 0 10px #00FF00;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="score">0</div>
    <div id="coins" class="hidden">
        <div class="coins-display">
            <div class="coin-icon-game">GU</div>
            <div class="coin-count" id="coinCount">0</div>
        </div>
    </div>
    
    <div class="coin-reward" id="coinReward">+2 GU!</div>
    <div class="stage-indicator" id="stageIndicator">STAGE 1</div>
    
    <div class="effect-indicator" id="effectIndicator">
        <span id="effectText">NORMAL</span>
    </div>
    
    <div class="boss-warning" id="bossWarning">BOSS BATTLE!</div>
    
    <div class="fade-overlay" id="fadeOverlay"></div>
    <div class="menu-overlay" id="menuOverlay" onclick="closeAllMenus()"></div>
    
    <div id="startScreen" class="active">
        <h1>BIRD OF FLAPPY</h1>
        <p>Click or Press SPACE to Start</p>
        
        <div class="stats-display">
            <div class="stat-item">
                <span style="font-size: 24px;">üèÜ</span>
                <span>High Score: <span id="menuHighScore">0</span></span>
            </div>
            <div class="stat-item">
                <div class="coin-icon-game" style="width: 30px; height: 30px; font-size: 12px;">GU</div>
                <span><span id="menuCoins">0</span> GU</span>
            </div>
        </div>
        
        <button class="play-button" onclick="startGameFromMenu()">‚ñ∂ PLAY</button>
        
        <div class="button-row">
            <button class="menu-button" onclick="toggleShop()">
                <span style="font-size: 48px;">üõí</span>
                <span>SKINS</span>
            </button>
            <button class="menu-button" onclick="toggleLeaderboard()">
                <span style="font-size: 48px;">üèÜ</span>
                <span>TOP 100</span>
            </button>
        </div>
    </div>
    
    <div id="shop">
        <button class="menu-button back-btn" onclick="toggleShop()">‚úñ CLOSE</button>
        <h1 style="font-size: 36px; margin-bottom: 15px; color: #FFD700; text-align: center;">SKIN SHOP</h1>
        
        <div class="shop-currency">
            <div class="shop-coin-icon">GU</div>
            <div class="shop-coin-count" id="shopCoins">0 GU</div>
        </div>
        
        <div class="shop-section">
            <div class="section-title">üéÆ CHARACTER SKINS</div>
            <div class="shop-grid" id="skinGrid"></div>
        </div>
    </div>
    
    <div id="leaderboard">
        <button class="menu-button back-btn" onclick="toggleLeaderboard()">‚úñ CLOSE</button>
        <h1 style="font-size: 36px; margin-bottom: 15px; color: #FFD700; text-align: center;">TOP 100 WORLD</h1>
        <div class="leaderboard-header">Most Pipes Passed</div>
        <div class="leaderboard-table" id="leaderboardTable">
            <div class="loading">Loading global leaderboard...</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const startScreen = document.getElementById('startScreen');
        const effectIndicator = document.getElementById('effectIndicator');
        const effectText = document.getElementById('effectText');
        const coinReward = document.getElementById('coinReward');
        const bossWarning = document.getElementById('bossWarning');
        const stageIndicator = document.getElementById('stageIndicator');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            PIPE_WIDTH = canvas.width * 0.08;
            PIPE_GAP = canvas.height * 0.38;
            BASE_PIPE_SPEED = canvas.width * 0.003;
            GROUND_HEIGHT = canvas.height * 0.15;
        });
        
        // Save data
        const saveData = {
            coins: parseInt(localStorage.getItem('flappyCoins') || '0'),
            highScore: parseInt(localStorage.getItem('flappyHighScore') || '0'),
            currentSkin: localStorage.getItem('flappySkin') || 'classic',
            unlockedSkins: JSON.parse(localStorage.getItem('flappyUnlockedSkins') || '["classic"]'),
            playerId: localStorage.getItem('flappyPlayerId') || generatePlayerId(),
            playerName: localStorage.getItem('flappyPlayerName') || generateCoolName()
        };
        
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function generateCoolName() {
            const adjectives = ['Swift', 'Epic', 'Mighty', 'Sky', 'Air', 'Flappy', 'Golden', 'Pixel', 'Pro', 'Master', 'Ultra', 'Hyper', 'Mega', 'Super', 'Turbo'];
            const nouns = ['Bird', 'Wing', 'Flyer', 'Flier', 'Pilot', 'Ace', 'Champ', 'Hero', 'Legend', 'King', 'Lord', 'Prince', 'Eagle', 'Hawk', 'Falcon'];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            return `${adj}${noun}${Math.floor(Math.random() * 100)}`;
        }
        
        function saveGame() {
            localStorage.setItem('flappyCoins', saveData.coins);
            localStorage.setItem('flappyHighScore', saveData.highScore);
            localStorage.setItem('flappySkin', saveData.currentSkin);
            localStorage.setItem('flappyUnlockedSkins', JSON.stringify(saveData.unlockedSkins));
            localStorage.setItem('flappyPlayerId', saveData.playerId);
            localStorage.setItem('flappyPlayerName', saveData.playerName);
        }
        
        // Skins
        const birdSkins = [
            { id: 'classic', name: 'Classic Bird', price: 0, emoji: 'üê§', description: 'The original flappy bird', color: '#FFD700' },
            { id: 'duck', name: 'Yellow Duck', price: 10, emoji: 'ü¶Ü', description: 'Quack quack!', color: '#FFD700' },
            { id: 'pigeon', name: 'City Pigeon', price: 20, emoji: 'üïäÔ∏è', description: 'Urban flyer', color: '#A9A9A9' },
            { id: 'owl', name: 'Wise Owl', price: 30, emoji: 'ü¶â', description: 'Night vision expert', color: '#8B4513' },
            { id: 'penguin', name: 'Penguin', price: 40, emoji: 'üêß', description: 'Tuxedo flyer', color: '#000000' },
            { id: 'bat', name: 'Bat', price: 50, emoji: 'ü¶á', description: 'Fly at night', color: '#333333' },
            { id: 'bee', name: 'Bumblebee', price: 70, emoji: 'üêù', description: 'Buzzy flyer', color: '#FFD700' },
            { id: 'ufo', name: 'UFO', price: 100, emoji: 'üõ∏', description: 'Alien spacecraft', color: '#00FF00' },
            { id: 'spaceship', name: 'Spaceship', price: 150, emoji: 'üöÄ', description: 'To infinity!', color: '#4169E1' },
            { id: 'airplane', name: 'Airplane', price: 200, emoji: '‚úàÔ∏è', description: 'Commercial flight', color: '#FFFFFF' },
            { id: 'dragon', name: 'Dragon', price: 300, emoji: 'üêâ', description: 'Fire-breathing', color: '#DC143C' },
            { id: 'unicorn', name: 'Unicorn', price: 400, emoji: 'ü¶Ñ', description: 'Magical horn', color: '#FFB6C1' },
            { id: 'phoenix', name: 'Phoenix', price: 500, emoji: 'üî•', description: 'Reborn from ashes', color: '#FF4500' },
            { id: 'superman', name: 'Superman', price: 600, emoji: 'ü¶∏', description: 'Faster than plane', color: '#FF0000' },
            { id: 'ninja', name: 'Ninja', price: 700, emoji: 'ü•∑', description: 'Stealth master', color: '#000000' },
            { id: 'robot', name: 'Robot', price: 800, emoji: 'ü§ñ', description: 'Mechanical marvel', color: '#808080' },
            { id: 'rainbow', name: 'Rainbow Bird', price: 1500, emoji: 'üåà', description: 'Color changing', color: 'rainbow' },
            { id: 'galaxy', name: 'Galaxy Bird', price: 1000, emoji: 'üåå', description: 'Cosmic traveler', color: '#4A00E0' },
            { id: 'gold', name: 'Golden Eagle', price: 2000, emoji: 'ü•á', description: 'Solid gold', color: '#FFD700' },
            { id: 'diamond', name: 'Diamond Bird', price: 5000, emoji: 'üíé', description: 'Sparkling gem', color: '#B9F2FF' },
            { id: 'king', name: 'King', price: 10000, emoji: 'üëë', description: 'Royal ruler', color: '#FFD700' }
        ];
        
        // Game variables
        let bird = {
            x: canvas.width * 0.15,
            y: canvas.height / 2,
            width: 40,
            height: 28,
            velocity: 0,
            gravity: 0.5,
            jump: -9,
            rotation: 0,
            horizontalMotion: 0
        };
        
        let pipes = [];
        let portals = [];
        let clouds = [];
        let score = 0;
        let coinsThisRound = 0;
        let totalCoins = saveData.coins;
        let gameStarted = false;
        let gameOver = false;
        let frame = 0;
        let groundX = 0;
        let gameActive = false;
        
        let difficulty = 1;
        let isBossBattle = false;
        let bossBattleStarted = false;
        
        // Portal effects
        let invertedControls = false;
        let screenRotated = false;
        let inPortalEffect = false;
        let activePortalType = null;
        let portalEffectDuration = 0;
        
        // PIPE CONFIGURATION
        let PIPE_WIDTH = canvas.width * 0.08;
        let PIPE_GAP = canvas.height * 0.38;
        let BASE_PIPE_SPEED = canvas.width * 0.003;
        let GROUND_HEIGHT = canvas.height * 0.15;
        
        // Coin reward milestones
        const coinMilestones = [
            { score: 20, coins: 2, message: "+2 GU!" },
            { score: 50, coins: 5, message: "+5 GU!" },
            { score: 100, coins: 10, message: "+10 GU!" },
            { score: 500, coins: 250, message: "+250 GU! INSANE!" }
        ];
        let reachedMilestones = new Set();
        
        // Initialize clouds
        for (let i = 0; i < 6; i++) {
            clouds.push({
                x: Math.random() * canvas.width,
                y: Math.random() * (canvas.height * 0.4),
                width: 60 + Math.random() * 40,
                speed: 0.3 + Math.random() * 0.5
            });
        }
        
        // Draw character
        function drawCharacter() {
            if (!gameStarted) return;
            
            ctx.save();
            
            // Apply screen rotation if active
            if (screenRotated) {
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(Math.PI);
                ctx.translate(-canvas.width / 2, -canvas.height / 2);
            }
            
            const oscillation = Math.sin(frame * 0.1) * 3;
            ctx.translate(bird.x + bird.width / 2 + oscillation, bird.y + bird.height / 2);
            ctx.rotate(bird.rotation * Math.PI / 180);
            
            const skin = birdSkins.find(s => s.id === saveData.currentSkin) || birdSkins[0];
            
            // Get color
            let bodyColor, wingColor;
            
            if (skin.color === 'rainbow') {
                const hue = (frame * 3) % 360;
                bodyColor = `hsl(${hue}, 100%, 50%)`;
                wingColor = `hsl(${(hue + 180) % 360}, 100%, 50%)`;
            } else {
                bodyColor = skin.color;
                wingColor = skin.color;
            }
            
            // Body
            ctx.fillStyle = bodyColor;
            ctx.fillRect(-20, -14, 40, 28);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.strokeRect(-20, -14, 40, 28);
            
            // Beak
            ctx.fillStyle = '#FF6600';
            ctx.beginPath();
            ctx.moveTo(20, -3);
            ctx.lineTo(32, 0);
            ctx.lineTo(20, 3);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Eye
            ctx.fillStyle = '#fff';
            ctx.fillRect(8, -10, 10, 10);
            ctx.fillStyle = '#000';
            ctx.fillRect(12, -8, 5, 6);
            
            // Wing
            ctx.fillStyle = wingColor;
            ctx.fillRect(-10, 5, 20, 10);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.strokeRect(-10, 5, 20, 10);
            
            // Special effects for certain skins
            if (skin.id === 'ufo') {
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(-15, 12, 5, 3);
                ctx.fillRect(-5, 12, 5, 3);
                ctx.fillRect(5, 12, 5, 3);
            } else if (skin.id === 'dragon' || skin.id === 'phoenix') {
                ctx.fillStyle = '#FF4500';
                for(let i = 0; i < 3; i++) {
                    const fireX = 25 + i * 5;
                    const fireY = Math.sin(frame * 0.1 + i) * 3;
                    ctx.beginPath();
                    ctx.arc(fireX, fireY, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (skin.id === 'robot') {
                ctx.fillStyle = '#00FF00';
                ctx.fillRect(-8, -8, 5, 5);
                ctx.fillRect(3, -8, 5, 5);
                ctx.fillStyle = '#FF0000';
                for(let i = -3; i <= 3; i++) {
                    ctx.fillRect(i*4 - 2, 5, 3, 3);
                }
            }
            
            ctx.restore();
        }
        
        function drawPipe(pipe) {
            // Boss battle pipe colors
            let pipeColor, pipeDark, pipeLight;
            
            if (isBossBattle) {
                // Flash between colors during boss battle
                const flash = Math.sin(frame * 0.2) > 0;
                pipeColor = flash ? '#FF0000' : '#00FF00';
                pipeDark = flash ? '#990000' : '#009900';
                pipeLight = flash ? '#FF6666' : '#66FF66';
            } else {
                pipeColor = '#5cb85c';
                pipeDark = '#2e7d32';
                pipeLight = '#7ed17e';
            }
            
            ctx.fillStyle = pipeColor;
            ctx.fillRect(pipe.x, 0, PIPE_WIDTH, pipe.top);
            
            ctx.fillStyle = pipeLight;
            ctx.fillRect(pipe.x + 5, 0, 8, pipe.top);
            
            ctx.fillStyle = pipeDark;
            ctx.fillRect(pipe.x + PIPE_WIDTH - 8, 0, 8, pipe.top);
            
            const capHeight = 30;
            ctx.fillStyle = pipeColor;
            ctx.fillRect(pipe.x - 5, pipe.top - capHeight, PIPE_WIDTH + 10, capHeight);
            ctx.fillStyle = pipeLight;
            ctx.fillRect(pipe.x, pipe.top - capHeight, 8, capHeight);
            ctx.fillStyle = pipeDark;
            ctx.fillRect(pipe.x + PIPE_WIDTH - 3, pipe.top - capHeight, 8, capHeight);
            
            ctx.fillStyle = pipeColor;
            ctx.fillRect(pipe.x, pipe.bottom, PIPE_WIDTH, canvas.height - pipe.bottom);
            
            ctx.fillStyle = pipeLight;
            ctx.fillRect(pipe.x + 5, pipe.bottom, 8, canvas.height - pipe.bottom);
            
            ctx.fillStyle = pipeDark;
            ctx.fillRect(pipe.x + PIPE_WIDTH - 8, pipe.bottom, 8, canvas.height - pipe.bottom);
            
            ctx.fillStyle = pipeColor;
            ctx.fillRect(pipe.x - 5, pipe.bottom, PIPE_WIDTH + 10, capHeight);
            ctx.fillStyle = pipeLight;
            ctx.fillRect(pipe.x, pipe.bottom, 8, capHeight);
            ctx.fillStyle = pipeDark;
            ctx.fillRect(pipe.x + PIPE_WIDTH - 3, pipe.bottom, 8, capHeight);
        }
        
        function drawPortal(portal) {
            ctx.save();
            
            const pulse = Math.sin(frame * 0.1) * 5;
            
            // Boss battle portal effects
            let outerColor, innerStart, innerEnd;
            
            if (isBossBattle) {
                // Crazy flashing portal colors
                const flash = Math.sin(frame * 0.3) > 0;
                outerColor = flash ? '#FF00FF' : '#00FFFF';
                innerStart = flash ? '#FF00FF' : '#00FFFF';
                innerEnd = flash ? 'rgba(255, 0, 255, 0.3)' : 'rgba(0, 255, 255, 0.3)';
            } else {
                outerColor = portal.type === 'invert' ? '#FF00FF' : '#00FFFF';
                innerStart = portal.type === 'invert' ? '#FF00FF' : '#00FFFF';
                innerEnd = portal.type === 'invert' ? 'rgba(255, 0, 255, 0.3)' : 'rgba(0, 255, 255, 0.3)';
            }
            
            // Outer ring
            ctx.strokeStyle = outerColor;
            ctx.lineWidth = isBossBattle ? 10 : 6;
            ctx.beginPath();
            ctx.arc(portal.x + portal.width/2, portal.y + portal.height/2, portal.width/2 + pulse, 0, Math.PI * 2);
            ctx.stroke();
            
            // Inner portal
            const gradient = ctx.createRadialGradient(
                portal.x + portal.width/2, portal.y + portal.height/2, 0,
                portal.x + portal.width/2, portal.y + portal.height/2, portal.width/2
            );
            
            gradient.addColorStop(0, innerStart);
            gradient.addColorStop(1, innerEnd);
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(portal.x + portal.width/2, portal.y + portal.height/2, portal.width/2 - 5, 0, Math.PI * 2);
            ctx.fill();
            
            // Portal symbol
            ctx.fillStyle = isBossBattle ? '#FFFF00' : '#FFFFFF';
            ctx.font = isBossBattle ? '24px Arial' : '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const symbol = portal.type === 'invert' ? '‚Üï' : '‚Üª';
            ctx.fillText(symbol, portal.x + portal.width/2, portal.y + portal.height/2);
            
            ctx.restore();
        }
        
        function drawClouds() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            clouds.forEach(cloud => {
                ctx.fillRect(cloud.x, cloud.y, cloud.width, 25);
                ctx.fillRect(cloud.x + 10, cloud.y - 15, cloud.width - 20, 20);
                ctx.fillRect(cloud.x + 20, cloud.y - 25, cloud.width - 40, 20);
                
                cloud.x -= cloud.speed * difficulty;
                if (cloud.x + cloud.width < 0) {
                    cloud.x = canvas.width;
                    cloud.y = Math.random() * (canvas.height * 0.4);
                }
            });
        }
        
        function drawGround() {
            const groundY = canvas.height - GROUND_HEIGHT;
            
            // Boss battle ground effect
            if (isBossBattle) {
                // Flashing ground
                const flash = Math.sin(frame * 0.2) > 0;
                ctx.fillStyle = flash ? '#8B0000' : '#8B4513';
                ctx.fillRect(0, groundY, canvas.width, GROUND_HEIGHT);
                
                // Crazy pattern
                for (let x = 0; x < canvas.width; x += 20) {
                    for (let y = groundY + 30; y < canvas.height; y += 20) {
                        const colorFlash = Math.sin(frame * 0.1 + x * 0.1) > 0;
                        ctx.fillStyle = colorFlash ? '#FF0000' : '#00FF00';
                        ctx.fillRect(x + (groundX % 20), y, 10, 10);
                    }
                }
            } else {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(0, groundY, canvas.width, GROUND_HEIGHT);
                
                ctx.fillStyle = '#654321';
                for (let x = 0; x < canvas.width; x += 20) {
                    for (let y = groundY + 30; y < canvas.height; y += 20) {
                        ctx.fillRect(x + (groundX % 20), y, 10, 10);
                    }
                }
            }
            
            // Grass
            ctx.fillStyle = isBossBattle ? (Math.sin(frame * 0.2) > 0 ? '#FF0000' : '#00FF00') : '#7EC850';
            for (let x = -20; x < canvas.width + 20; x += 10) {
                const offsetX = (x + groundX) % canvas.width;
                if (offsetX < 0) continue;
                ctx.fillRect(offsetX, groundY, 10, 5);
            }
            
            ctx.fillStyle = isBossBattle ? (Math.cos(frame * 0.2) > 0 ? '#00FF00' : '#FF0000') : '#5EAA30';
            for (let x = -20; x < canvas.width + 20; x += 15) {
                const offsetX = (x + groundX) % canvas.width;
                if (offsetX < 0) continue;
                ctx.fillRect(offsetX, groundY, 8, 15);
                ctx.fillRect(offsetX + 3, groundY + 15, 8, 15);
            }
            
            ctx.fillStyle = isBossBattle ? '#FFFF00' : '#9EE86F';
            for (let x = -15; x < canvas.width + 15; x += 15) {
                const offsetX = (x + groundX) % canvas.width;
                if (offsetX < 0) continue;
                ctx.fillRect(offsetX, groundY + 5, 4, 10);
            }
            
            if (gameStarted && gameActive && !gameOver) {
                groundX -= BASE_PIPE_SPEED * difficulty;
                if (groundX <= -canvas.width) groundX = 0;
            }
        }
        
        function createPipe() {
            const minTop = canvas.height * 0.15;
            const maxTop = canvas.height - GROUND_HEIGHT - PIPE_GAP - 100;
            const top = Math.random() * (maxTop - minTop) + minTop;
            
            pipes.push({
                x: canvas.width,
                top: top,
                bottom: top + PIPE_GAP,
                scored: false
            });
        }
        
        function createPortal() {
            const types = ['invert', 'rotate'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            const minY = canvas.height * 0.2;
            const maxY = canvas.height * 0.7;
            const y = Math.random() * (maxY - minY) + minY;
            
            portals.push({
                x: canvas.width,
                y: y,
                width: isBossBattle ? 80 : 60,
                height: isBossBattle ? 80 : 60,
                type: type,
                active: true
            });
        }
        
        function update() {
            if (!gameStarted || !gameActive || gameOver) return;
            
            frame++;
            
            // Check for boss battle
            if (score >= 250 && !bossBattleStarted) {
                startBossBattle();
            }
            
            // Update stage indicator
            updateStageIndicator();
            
            // Check coin milestones
            checkCoinMilestones();
            
            if (portalEffectDuration > 0) {
                portalEffectDuration--;
                if (portalEffectDuration === 0) {
                    removePortalEffect();
                }
            }
            
            // Boss battle difficulty
            if (isBossBattle) {
                difficulty = 3 + (Math.sin(frame * 0.05) * 0.5); // Insane speed with variation
            } else {
                difficulty = 1 + (Math.floor(score / 5) * 0.15);
            }
            
            let currentGravity = invertedControls ? -bird.gravity : bird.gravity;
            let currentJump = invertedControls ? -bird.jump : bird.jump;
            
            bird.velocity += currentGravity;
            bird.y += bird.velocity;
            
            bird.horizontalMotion = Math.sin(frame * 0.08) * 2;
            
            if (bird.velocity < 0) {
                bird.rotation = Math.max(-25, bird.velocity * 3);
            } else {
                bird.rotation = Math.min(90, bird.velocity * 2);
            }
            
            if (invertedControls) {
                if (bird.y <= 0) {
                    triggerDeath();
                    return;
                }
                if (bird.y + bird.height >= canvas.height - GROUND_HEIGHT) {
                    bird.y = canvas.height - GROUND_HEIGHT - bird.height;
                    bird.velocity = 0;
                }
            } else {
                if (bird.y + bird.height >= canvas.height - GROUND_HEIGHT) {
                    triggerDeath();
                    return;
                }
                if (bird.y <= 0) {
                    bird.y = 0;
                }
            }
            
            pipes.forEach((pipe) => {
                pipe.x -= BASE_PIPE_SPEED * difficulty;
                
                if (!pipe.scored && pipe.x + PIPE_WIDTH < bird.x) {
                    pipe.scored = true;
                    score++;
                    coinsThisRound++;
                    totalCoins++;
                    scoreDisplay.textContent = score;
                    document.getElementById('coinCount').textContent = totalCoins;
                }
                
                if (bird.x + bird.horizontalMotion < pipe.x + PIPE_WIDTH && 
                    bird.x + bird.horizontalMotion + bird.width > pipe.x && 
                    (bird.y < pipe.top || bird.y + bird.height > pipe.bottom)) {
                    triggerDeath();
                    return;
                }
            });
            
            pipes = pipes.filter(pipe => pipe.x > -PIPE_WIDTH);
            
            portals.forEach((portal) => {
                portal.x -= BASE_PIPE_SPEED * difficulty;
                
                if (portal.active && 
                    bird.x < portal.x + portal.width && 
                    bird.x + bird.width > portal.x && 
                    bird.y < portal.y + portal.height && 
                    bird.y + bird.height > portal.y) {
                    
                    activatePortal(portal.type);
                    portal.active = false;
                }
            });
            
            portals = portals.filter(portal => portal.x > -100);
            
            // Pipe spawning - more frequent in boss battle
            let pipeSpawnRate;
            if (isBossBattle) {
                pipeSpawnRate = Math.max(20, 40 - Math.floor((score - 250) / 10) * 2); // Very fast
            } else {
                pipeSpawnRate = Math.max(60, 120 - Math.floor(score / 5) * 10);
            }
            
            if (frame % pipeSpawnRate === 0) {
                createPipe();
            }
            
            // Portal spawning - insane in boss battle
            let portalSpawnRate;
            if (isBossBattle) {
                portalSpawnRate = 30; // Portal every 30 frames!
            } else {
                portalSpawnRate = Math.max(300, 900 - Math.floor(score / 5) * 60);
            }
            
            if (score > 0 && frame % portalSpawnRate === 0) {
                createPortal();
            }
            
            updateEffectIndicator();
        }
        
        function checkCoinMilestones() {
            for (const milestone of coinMilestones) {
                if (score >= milestone.score && !reachedMilestones.has(milestone.score)) {
                    reachedMilestones.add(milestone.score);
                    
                    // Add coins
                    totalCoins += milestone.coins;
                    saveData.coins = totalCoins;
                    
                    // Show reward message
                    coinReward.textContent = milestone.message;
                    coinReward.classList.add('show');
                    
                    // Hide after delay
                    setTimeout(() => {
                        coinReward.classList.remove('show');
                    }, 2000);
                    
                    // Update coin display
                    document.getElementById('coinCount').textContent = totalCoins;
                    
                    break;
                }
            }
        }
        
        function startBossBattle() {
            isBossBattle = true;
            bossBattleStarted = true;
            
            // Show boss warning
            bossWarning.classList.add('show');
            
            // Remove after animation
            setTimeout(() => {
                bossWarning.classList.remove('show');
            }, 2000);
            
            // Clear existing pipes and portals
            pipes = [];
            portals = [];
            
            // Create initial chaos
            for (let i = 0; i < 5; i++) {
                createPipe();
            }
            for (let i = 0; i < 3; i++) {
                createPortal();
            }
            
            // Make everything crazy
            invertedControls = Math.random() > 0.5;
            screenRotated = Math.random() > 0.5;
            
            if (invertedControls) {
                effectText.textContent = 'BOSS: CONTROLS INVERTED!';
                effectText.style.color = '#FF00FF';
                effectIndicator.classList.add('active');
            }
            
            if (screenRotated) {
                effectText.textContent = 'BOSS: SCREEN ROTATED!';
                effectText.style.color = '#00FFFF';
                effectIndicator.classList.add('active');
            }
        }
        
        function updateStageIndicator() {
            if (isBossBattle) {
                stageIndicator.textContent = 'BOSS BATTLE!';
                stageIndicator.style.color = '#FF0000';
                stageIndicator.style.textShadow = '0 0 10px #FF0000';
            } else if (score >= 100) {
                stageIndicator.textContent = 'STAGE 3';
                stageIndicator.style.color = '#FFA500';
                stageIndicator.style.textShadow = '0 0 10px #FFA500';
            } else if (score >= 50) {
                stageIndicator.textContent = 'STAGE 2';
                stageIndicator.style.color = '#00FF00';
                stageIndicator.style.textShadow = '0 0 10px #00FF00';
            } else {
                stageIndicator.textContent = 'STAGE 1';
                stageIndicator.style.color = '#00FF00';
                stageIndicator.style.textShadow = '0 0 10px #00FF00';
            }
        }
        
        function activatePortal(type) {
            inPortalEffect = true;
            activePortalType = type;
            portalEffectDuration = isBossBattle ? 90 : 180; // Shorter in boss battle
            
            if (type === 'invert') {
                invertedControls = !invertedControls;
                effectText.textContent = invertedControls ? 'CONTROLS INVERTED!' : 'CONTROLS NORMAL';
                effectText.style.color = '#FF00FF';
            } else if (type === 'rotate') {
                screenRotated = !screenRotated;
                effectText.textContent = screenRotated ? 'SCREEN ROTATED!' : 'SCREEN NORMAL';
                effectText.style.color = '#00FFFF';
            }
            
            effectIndicator.classList.add('active');
        }
        
        function removePortalEffect() {
            inPortalEffect = false;
            activePortalType = null;
            effectIndicator.classList.remove('active');
        }
        
        function updateEffectIndicator() {
            if (inPortalEffect) {
                const pulse = Math.sin(frame * 0.2) * 0.5 + 0.5;
                effectIndicator.style.opacity = 0.7 + pulse * 0.3;
                
                const seconds = Math.ceil(portalEffectDuration / 60);
                const currentText = effectText.textContent.replace(/ \(\d+s\)$/, '');
                effectText.textContent = `${currentText} (${seconds}s)`;
            }
        }
        
        function draw() {
            // Boss battle flashing background
            if (isBossBattle) {
                const flash = Math.sin(frame * 0.1) > 0;
                ctx.fillStyle = flash ? '#000000' : '#330033';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add crazy effects
                for (let i = 0; i < 20; i++) {
                    const x = (frame * 2 + i * 100) % canvas.width;
                    const y = (frame * 1 + i * 50) % canvas.height;
                    const size = Math.sin(frame * 0.05 + i) * 10 + 5;
                    const hue = (frame * 2 + i * 30) % 360;
                    
                    ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#4EC0CA');
                gradient.addColorStop(0.7, '#7DD0D8');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            ctx.save();
            
            if (screenRotated) {
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(Math.PI);
                ctx.translate(-canvas.width / 2, -canvas.height / 2);
            }
            
            drawClouds();
            
            if (gameStarted) {
                pipes.forEach(drawPipe);
                portals.forEach(drawPortal);
                drawCharacter();
            }
            
            drawGround();
            
            ctx.restore();
            
            if (inPortalEffect && activePortalType === 'rotate') {
                ctx.fillStyle = 'rgba(0, 255, 255, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        function flap() {
            if (!gameStarted) return;
            
            if (!gameActive) {
                return;
            }
            
            if (gameOver) {
                resetGame();
                return;
            }
            
            const currentJump = invertedControls ? -bird.jump : bird.jump;
            bird.velocity = currentJump;
        }
        
        function startWaitTimer() {
            setTimeout(() => {
                gameActive = true;
            }, 2000);
        }
        
        async function triggerDeath() {
            if (gameOver) return;
            
            gameOver = true;
            
            const fadeOverlay = document.getElementById('fadeOverlay');
            fadeOverlay.classList.add('active');
            
            saveData.coins = totalCoins;
            
            if (score > saveData.highScore) {
                saveData.highScore = score;
            }
            
            await submitToGlobalLeaderboard(score);
            
            saveGame();
            
            setTimeout(() => {
                resetGame();
                startScreen.classList.add('active');
                document.getElementById('score').classList.add('hidden');
                document.getElementById('coins').classList.add('hidden');
                updateCoinDisplays();
                
                setTimeout(() => {
                    fadeOverlay.classList.remove('active');
                }, 100);
            }, 1000);
        }
        
        // Global leaderboard
        const GLOBAL_LEADERBOARD_KEY = 'flappy_global_leaderboard_v2';
        
        async function submitToGlobalLeaderboard(score) {
            try {
                const entry = {
                    playerId: saveData.playerId,
                    playerName: saveData.playerName,
                    score: score,
                    skin: saveData.currentSkin,
                    date: new Date().toISOString(),
                    timestamp: Date.now()
                };
                
                let globalLeaderboard = JSON.parse(localStorage.getItem(GLOBAL_LEADERBOARD_KEY) || '[]');
                
                const existingIndex = globalLeaderboard.findIndex(e => e.playerId === saveData.playerId);
                
                if (existingIndex !== -1) {
                    if (score > globalLeaderboard[existingIndex].score) {
                        globalLeaderboard[existingIndex] = entry;
                    }
                } else {
                    globalLeaderboard.push(entry);
                }
                
                globalLeaderboard.sort((a, b) => b.score - a.score);
                globalLeaderboard = globalLeaderboard.slice(0, 100);
                
                localStorage.setItem(GLOBAL_LEADERBOARD_KEY, JSON.stringify(globalLeaderboard));
                
            } catch (error) {
                console.error('Failed to submit to leaderboard:', error);
            }
        }
        
        async function loadGlobalLeaderboard() {
            try {
                const localScores = JSON.parse(localStorage.getItem(GLOBAL_LEADERBOARD_KEY) || '[]');
                return localScores
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 100);
            } catch (error) {
                return [];
            }
        }
        
        async function renderLeaderboard() {
            const table = document.getElementById('leaderboardTable');
            table.innerHTML = '<div class="loading">Loading global leaderboard...</div>';
            
            try {
                const leaderboard = await loadGlobalLeaderboard();
                
                if (leaderboard.length === 0) {
                    table.innerHTML = '<div class="loading">No scores yet! Be the first to make the leaderboard!</div>';
                    return;
                }
                
                let html = '';
                
                leaderboard.forEach((entry, i) => {
                    const isYou = entry.playerId === saveData.playerId;
                    const rowClass = i < 3 ? 'top' : (isYou ? 'you' : '');
                    
                    const displayName = entry.playerName.length > 15 ? 
                        entry.playerName.substring(0, 12) + '...' : 
                        entry.playerName;
                    
                    html += `
                        <div class="leaderboard-row ${rowClass}">
                            <span>#${i + 1} ${displayName}</span>
                            <span>${entry.score} pipes</span>
                        </div>
                    `;
                });
                
                table.innerHTML = html;
                
            } catch (error) {
                table.innerHTML = '<div class="error">Failed to load leaderboard. Try again later.</div>';
            }
        }
        
        function resetGame() {
            bird.y = canvas.height / 2;
            bird.velocity = 0;
            bird.rotation = 0;
            bird.horizontalMotion = 0;
            pipes = [];
            portals = [];
            score = 0;
            coinsThisRound = 0;
            gameStarted = false;
            gameActive = false;
            gameOver = false;
            frame = 0;
            groundX = 0;
            difficulty = 1;
            
            invertedControls = false;
            screenRotated = false;
            inPortalEffect = false;
            activePortalType = null;
            portalEffectDuration = 0;
            effectIndicator.classList.remove('active');
            
            isBossBattle = false;
            bossBattleStarted = false;
            reachedMilestones.clear();
            
            coinReward.classList.remove('show');
            bossWarning.classList.remove('show');
            
            scoreDisplay.textContent = '0';
        }
        
        function startGameFromMenu() {
            startScreen.classList.remove('active');
            closeAllMenus();
            
            setTimeout(() => {
                gameStarted = true;
                document.getElementById('score').classList.remove('hidden');
                document.getElementById('coins').classList.remove('hidden');
                document.getElementById('coinCount').textContent = totalCoins;
                pipes = [];
                portals = [];
                createPipe();
                startWaitTimer();
            }, 100);
        }
        
        function toggleShop() {
            const shop = document.getElementById('shop');
            const overlay = document.getElementById('menuOverlay');
            const isOpen = shop.classList.contains('open');
            
            if (isOpen) {
                shop.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                closeAllMenus();
                shop.classList.add('open');
                overlay.classList.add('active');
                renderShop();
            }
        }
        
        function toggleLeaderboard() {
            const leaderboard = document.getElementById('leaderboard');
            const overlay = document.getElementById('menuOverlay');
            const isOpen = leaderboard.classList.contains('open');
            
            if (isOpen) {
                leaderboard.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                closeAllMenus();
                leaderboard.classList.add('open');
                overlay.classList.add('active');
                renderLeaderboard();
            }
        }
        
        function closeAllMenus() {
            document.getElementById('shop').classList.remove('open');
            document.getElementById('leaderboard').classList.remove('open');
            document.getElementById('menuOverlay').classList.remove('active');
        }
        
        function renderShop() {
            const skinGrid = document.getElementById('skinGrid');
            skinGrid.innerHTML = '';
            
            const sortedSkins = [...birdSkins].sort((a, b) => a.price - b.price);
            
            sortedSkins.forEach(skin => {
                const card = createShopItem(skin, 'skin');
                skinGrid.appendChild(card);
            });
            
            updateCoinDisplays();
        }
        
        function createShopItem(item, type) {
            const card = document.createElement('div');
            card.className = 'item-card';
            
            let isUnlocked = saveData.unlockedSkins.includes(item.id);
            let isEquipped = saveData.currentSkin === item.id;
            
            if (isEquipped) card.classList.add('equipped');
            if (!isUnlocked && item.price > 0) card.classList.add('locked');
            
            const preview = document.createElement('div');
            preview.className = 'item-preview';
            preview.textContent = item.emoji;
            
            if (item.color === 'rainbow') {
                preview.style.background = 'linear-gradient(90deg, red, orange, yellow, green, blue, purple)';
            } else {
                preview.style.background = item.color;
            }
            
            const info = document.createElement('div');
            info.className = 'item-info';
            
            const name = document.createElement('div');
            name.className = 'item-name';
            name.textContent = `${item.emoji} ${item.name}`;
            
            const desc = document.createElement('div');
            desc.className = 'item-description';
            desc.textContent = item.description;
            
            const price = document.createElement('div');
            price.className = 'item-price';
            
            if (isUnlocked || item.price === 0) {
                if (isEquipped) {
                    price.textContent = '‚úì EQUIPPED';
                    price.style.color = '#44FF44';
                } else if (item.price === 0) {
                    price.textContent = 'FREE';
                    price.style.color = '#4EC0CA';
                    card.onclick = () => equipItem(item.id, type);
                } else {
                    price.textContent = 'EQUIP';
                    price.style.color = '#4EC0CA';
                    card.onclick = () => equipItem(item.id, type);
                }
            } else {
                const coinIcon = document.createElement('div');
                coinIcon.className = 'shop-coin-icon';
                coinIcon.style.width = '20px';
                coinIcon.style.height = '20px';
                coinIcon.style.fontSize = '14px';
                coinIcon.textContent = 'GU';
                price.appendChild(coinIcon);
                price.appendChild(document.createTextNode(' ' + item.price + ' GU'));
                card.onclick = () => buyItem(item, type);
            }
            
            info.appendChild(name);
            info.appendChild(desc);
            info.appendChild(price);
            card.appendChild(preview);
            card.appendChild(info);
            
            return card;
        }
        
        function buyItem(item, type) {
            if (saveData.coins >= item.price) {
                saveData.coins -= item.price;
                totalCoins = saveData.coins;
                saveData.unlockedSkins.push(item.id);
                saveData.currentSkin = item.id;
                
                saveGame();
                renderShop();
                updateCoinDisplays();
            } else {
                alert(`Not enough GU coins! You need ${item.price} GU but only have ${saveData.coins} GU.`);
            }
        }
        
        function equipItem(itemId, type) {
            saveData.currentSkin = itemId;
            saveGame();
            renderShop();
        }
        
        function updateCoinDisplays() {
            document.getElementById('menuCoins').textContent = saveData.coins;
            document.getElementById('menuHighScore').textContent = saveData.highScore;
            document.getElementById('shopCoins').textContent = saveData.coins + ' GU';
        }
        
        canvas.addEventListener('click', flap);
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (!gameStarted && startScreen.classList.contains('active')) {
                    startGameFromMenu();
                } else {
                    flap();
                }
            }
        });
        
        // Initialize
        updateCoinDisplays();
        gameLoop();
        
        // Ensure player has a name
        if (!saveData.playerName) {
            saveData.playerName = generateCoolName();
            saveGame();
        }
    </script>
</body>
</html>
